{% extends 'dashboard/dashboard_base.html' %}
{% load static %}
{% block title %}
  Asistensi
{% endblock %}
{% block content %}
  <div class="breadcrumb">
    <div class="row">
      <h3 class="heading mb-2">Asistensi</h3>
      <span class="mb-0">
        <span class="text-muted fw-light">Kegiatan /</span>
        <span class="text-muted fw-light">PSM /</span>
        <span class="ms-1 fw-medium">Asistensi</span>
      </span>
    </div>
  </div>

  <section id="app">
    <div class="card">
      <div class="card-body">
      <div id="headline" class="mb-3">
        <h3 class="text-center">
          Kegiatan Asistensi Kotan<br />
          <span id="currentYear"></span>
        </h3>
        <hr />
      </div>

      <div class="action-button">
        <div class="d-flex justify-content-end mb-3 gap-2">
          <button class="btn btn-success" data-bs-toggle="modal" onclick="handleExport()">
            <i class="fas fa-file-export me-2"></i>Ekspor Data
          </button>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModal">
            <i class="fas fa-plus me-2"></i>Tambah Data
          </button>
        </div>
      </div>
        <div class="table-responsive">
          {% include 'psm/asistensi/table2.html' %}
        </div>
      </div>
    </div>
  </section>
{% endblock %}

{% block css_tambahan %}
  <link rel="stylesheet" href="{% static 'assets/dashboard/vendor/libs/datatables-bs5/datatables.bootstrap5.css' %}" />
{% endblock %}

{% block js_tambahan %}
<script src="{% static 'assets/dashboard/vendor/libs/datatables-bs5/datatables-bootstrap5.js' %}"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script type="text/javascript" src="https://oss.sheetjs.com/sheetjs/xlsx.full.min.js"></script>

<script>
  const { createApp, ref, onMounted, computed } = Vue;
  createApp({
    setup() {
      let asistensiData = ref(null);
      let satkerLevel = parseInt('{{ user.profile.satker.level }}');
      let perPage = ref(10);
      let currentPage = ref(1);
      let searchField = ref(null);
      let filteredPage = ref(null);
      const totalPage = computed(() => {
        if (asistensiData.value) {
          return Math.ceil(asistensiData.value.length / perPage.value);
        }
        else return 0;
      });

      const pagedData = computed(() => {
        if (filteredPage.value) {
          d = filteredPage.value.slice((currentPage.value - 1) * perPage.value, (currentPage.value) * perPage.value);
          return d;
        }
        else return [];
      });

      function searchData(e) {
        filteredPage.value = asistensiData.value.filter((data) => {
          idx = String(data.satker.toUpperCase());
          // target = String(data.target.toUpperCase());
          bool1 = idx.indexOf(searchField.value.toUpperCase()) > -1;
          bool2 = target.indexOf(searchField.value.toUpperCase()) > -1;
          return bool1 || bool2;
        });
      };

      function hideableButton(status, satkerLevel, type) {
        if (type == 'kirim') {
          return satkerLevel != 2 && ((satkerLevel == 0 && status < 2) || (satkerLevel == 1 && status < 1));
        } else if (type == 'edit') {
          return satkerLevel == 2 || ((satkerLevel == 0 && status < 2) || (satkerLevel == 1 && status < 1));
        }
      }

      const apiURL = (satkerLevel == 1 ? '/kegiatan/api/v1/psm/asistensi/get_data_bnnk/?format=datatables' : '/kegiatan/api/v1/psm/asistensi/?format=datatables')
      function loadData() {
        tableContent = [];
        axios.get(apiURL).then(function (response) {
          data = response.data.data;
          for ([key, value] of Object.entries(data)) {
            baris = {
              'class': 'table-primary',
              'hide_satker': false,
              'index': parseInt(key) + 1,
              'satker': value.satker.nama_satker + '(' + value.data.length + ' kegiatan)',
              'jumlah_kegiatan': '',
              'tanggal': '',
              'jumlah_peserta': '',
              'stakeholder': '',
              'deskripsi': '',
              'kendala': '',
              'kesimpulan': '',
              'tindak_lanjut': '',
              'dokumentasi': '',
              'status': '',
              'type': 'parent'
            };
            tableContent.push(baris);
            for ([key2, value2] of Object.entries(value.data)) {
              baris = {
                'class': 'table-light',
                'hide_satker': true,
                'index': (parseInt(key) + 1) + '.' + (parseInt(key2) + 1),
                'id': value2.id,
                'satker': value2.satker.nama_satker,
                'jumlah_kegiatan': value2.jumlah_kegiatan,
                'tanggal': value2.tanggal_awal + '-' + value2.tanggal_akhir,
                'jumlah_peserta': value2.jumlah_peserta,
                'stakeholder': value2.stakeholder,
                'deskripsi': value2.deskripsi,
                'kendala': value2.kendala,
                'kesimpulan': value2.kesimpulan,
                'tindak_lanjut': value2.tindak_lanjut,
                'dokumentasi': value2.dokumentasi,
                'status': value2.status,
                'level': value2.satker.level,
                'type': 'child',
                'kirim': hideableButton(value2.status, satkerLevel, 'kirim'),
                'edit': hideableButton(value2.status, satkerLevel, 'edit'),
                'hapus': hideableButton(value2.status, satkerLevel, 'edit'),
              };
              tableContent.push(baris);
            }
            if (value.detail !== undefined && value.detail.length > 0) {
              for ([key3, value3] of Object.entries(value.detail)) {
                baris = {
                  'class': 'table-secondary',
                  'hide_satker': false, 'index': (parseInt(key) + 1) + '.' + (parseInt(key2) + 1) + '.' + (parseInt(key3) + 1),
                  'satker': value3.satker.nama_satker + '(' + value3.data.length + ' kegiatan)',
                  'jumlah_kegiatan': '',
                  'tanggal': '',
                  'jumlah_peserta': '',
                  'stakeholder': '',
                  'deskripsi': '',
                  'kendala': '',
                  'kesimpulan': '',
                  'tindak_lanjut': '',
                  'dokumentasi': '',
                  'status': '',
                  'type': 'parent'
                };
                tableContent.push(baris);
                for ([key4, value4] of Object.entries(value3.data)) {
                  baris = {
                    'class': 'table-light',
                    'hide_satker': true,
                    'index': (parseInt(key) + 1) + '.' + (parseInt(key2) + 1) + '.' + (parseInt(key3) + 1) + '.' + (parseInt(key4) + 1),
                    'id': value4.id,
                    'satker': value4.satker.nama_satker,
                    'jumlah_kegiatan': value4.jumlah_kegiatan,
                    'tanggal': value4.tanggal_awal + '-' + value4.tanggal_akhir,
                    'jumlah_peserta': value4.jumlah_peserta,
                    'stakeholder': value4.stakeholder,
                    'deskripsi': value4.deskripsi,
                    'kendala': value4.kendala,
                    'kesimpulan': value4.kesimpulan,
                    'tindak_lanjut': value4.tindak_lanjut,
                    'dokumentasi': value2.dokumentasi,
                    'level': value4.satker.level,
                    'status': value4.status,
                    'type': 'child',
                    'kirim': hideableButton(value4.status, satkerLevel, 'kirim'),
                    'edit': hideableButton(value4.status, satkerLevel, 'edit'),
                    'hapus': hideableButton(value4.status, satkerLevel, 'edit'),
                  };
                  tableContent.push(baris);
                }
              }
            }
          }
          asistensiData.value = tableContent;
          filteredPage.value = asistensiData.value;
        });
      };

      onMounted(() => {
        loadData();
      });
      return {
        asistensiData,
        satkerLevel,
        loadData,
        // handleEditModal,
        // handleDelete,
        // handleKirim,
        totalPage,
        perPage,
        currentPage,
        pagedData,
        searchData,
        searchField
      }
    },
    delimiters: ['${', '}']
  }).mount('#app');
</script>

<!-- script handle crud -->
<script>
  async function handleDate(event, target) {
    const currentDate = moment().format('YYYY-MM-DD');
    const valueDate = $(event.target).val();
    (valueDate === currentDate ? $(`#${target}tanggal_akhir`).attr('disabled', true) : $(`#${target}tanggal_akhir`).attr('disabled', false));
  }

  async function handlePost(e) {
    e.preventDefault();
    showSwalLoading();

    const tanggal_awal = $("#create__tanggal_awal").val();
    const tanggal_akhir = $("#create__tanggal_akhir").val();
    const satker = $("#create__satker").val();
    const deskripsi = $("#create__deskripsi").val();
    const kendala = $("#create__kendala").val();
    const kesimpulan = $("#create__kesimpulan").val();
    const tindak_lanjut = $("#create__tindak_lanjut").val();
    const jumlah_peserta = $("#create__jumlah_peserta").val();
    const jumlah_kegiatan = $("#create__jumlah_kegiatan").val();
    const stakeholder = $("#create__stakeholder").val();
    const dokumentasi = $("#create__dokumentasi")[0].files[0];

    const data = {
      satker,
      tanggal_awal,
      tanggal_akhir,
      deskripsi,
      kendala,
      kesimpulan,
      tindak_lanjut,
      dokumentasi,
      jumlah_kegiatan,
      jumlah_peserta,
      stakeholder,
    };
    console.log(data);

    const formData = new FormData();

    formData.append("tanggal_awal", tanggal_awal);
    formData.append("tanggal_akhir", tanggal_akhir);
    formData.append("satker", parseInt(satker));
    formData.append("deskripsi", deskripsi);
    formData.append("kendala", kendala);
    formData.append("kesimpulan", kesimpulan);
    formData.append("jumlah_kegiatan", jumlah_kegiatan);
    formData.append("jumlah_peserta", jumlah_peserta);
    formData.append("stakeholder", stakeholder);
    formData.append("tindak_lanjut", tindak_lanjut);
    formData.append("dokumentasi", dokumentasi);

    try {
      const response = await axios.post(
        `/kegiatan/api/v1/psm/asistensi/perform_create/`,
        formData,
        {
          headers: {
            "Content-Type": "multipart/form-data",
          },
        }
      );

      $("div#createModal").modal("hide");
      showSwalSuccess(
        "Berhasil!",
        `Data kegiatan telah <b>berhasil</b> ditambahkan!`
      );
    } catch (error) {
      showSwalGenericError();
      console.error("Terjadi kesalahan :", error);
    } finally {
      vm.loadData();
    }
  }

  // async function handleEdit(e) {
  //   e.preventDefault();
  //   showSwalLoading();

  //   const id = $('#edit__id').val();
  //   const tanggal_awal = $("#edit__tanggal_awal").val();
  //   const tanggal_akhir = $("#edit__tanggal_akhir").val();
  //   const satker = $("#edit__satker").val();
  //   const satker_target = $("#edit__satker_target").val();
  //   const deskripsi = $("#edit__deskripsi").val();
  //   const kendala = $("#edit__kendala").val();
  //   const kesimpulan = $("#edit__kesimpulan").val();
  //   const tindak_lanjut = $("#edit__tindak_lanjut").val();
  //   const dokumentasi = $("#edit__dokumentasi")[0].files[0];

  //   const data = {
  //     id,
  //     satker,
  //     satker_target,
  //     tanggal_awal,
  //     tanggal_akhir,
  //     deskripsi,
  //     kendala,
  //     kesimpulan,
  //     tindak_lanjut,
  //     dokumentasi,
  //   };
  //   console.log(data);

  //   const formData = new FormData();

  //   formData.append("id", id);
  //   formData.append("tanggal_awal", tanggal_awal);
  //   formData.append("tanggal_akhir", tanggal_akhir);
  //   formData.append("satker", parseInt(satker));
  //   formData.append("satker_target", parseInt(satker_target));
  //   formData.append("deskripsi", deskripsi);
  //   formData.append("kendala", kendala);
  //   formData.append("kesimpulan", kesimpulan);
  //   formData.append("tindak_lanjut", tindak_lanjut);
  //   if (dokumentasi) { formData.append('dokumentasi', dokumentasi); }

  //   try {
  //     const response = await axios.patch(
  //       `/kegiatan/api/v1/psm/rakernis/perform_update/`, formData, {
  //       headers: {
  //         "Content-Type": "multipart/form-data",
  //       },
  //     }
  //     );

  //     $("div#modalEdit").modal("hide");
  //     showSwalSuccess('Berhasil!', `Data kegiatan telah <b>berhasil</b> diperbarui!`);
  //     location.reload()

  //   } catch (error) {
  //     showSwalGenericError();
  //     console.error("Terjadi kesalahan :", error);
  //   }
  // }

  // async function handleKirim(data) {
  //   const confirmResult = await showSwalConfirm(`Apakah anda yakin untuk mengirim semua kegiatan dari Satuan Kerja <b>${data.nama}</b>`, 'Ya, kirim data');
  //   if (!confirmResult.isConfirmed) return;
  //   showSwalLoading();
  //   await sleep(1000);
  //   try {
  //     const response = await axios.post(`/kegiatan/api/v1/psm/rakernis/kirim_kegiatan/?id=${data.id}`);
  //     console.log('Respose :', response);
  //     const sendedToParent = response.data.parent.keterangan;
  //     showSwalSuccess('Berhasil', `Data <b>kegiatan</b> untuk <b>${data.nama}</b> telah berhasil <b>dikirimkan ke <b>${sendedToParent}</b></b>`);
  //     reloadAllDataTables();
  //   } catch (error) {
  //     showSwalGenericError();
  //     console.error('Terjadi kesalahan :', error);
  //   }
  // }

  async function handleExport() {
    var tbl = document.getElementById('__table');
    /* create a workbook */
    var wb = XLSX.utils.table_to_book(tbl);
    /* export to file */
    XLSX.writeFile(wb, "SheetJSTable.xlsx");
  }
</script>
{% endblock %}
{% block modal_tambahan %}
  {% include 'psm/asistensi/modals/create.html' %}
  {% include 'psm/asistensi/create_kegiatan.html' %}
  {% include 'psm/asistensi/edit.html' %}
  {% include 'psm/asistensi/edit_kegiatan.html' %}
  {% include 'psm/asistensi/detail.html' %}
{% endblock %}
