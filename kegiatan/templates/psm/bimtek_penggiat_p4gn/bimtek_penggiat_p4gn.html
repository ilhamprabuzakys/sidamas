{% extends 'dashboard/dashboard_base.html' %}
{% load static %}
{% block title %}
Bintek Penggiat P4GN
{% endblock %}
{% block content %}
<div class="breadcrumb">
    <div class="row">
        <h3 class="heading mb-2">Bimbingan Teknis Penggiat P4GN</h3>
        <span class="mb-0">
            <span class="text-muted fw-light">Kegiatan /</span>
            <span class="text-muted fw-light">PSM /</span>
            <span class="ms-1 fw-medium">Bimbingan Teknis Penggiat P4GN</span>
        </span>
    </div>
</div>

<section id="__data">
    <div class="card">
        <div class="card-body">
            <div id="headline" class="mb-3">
                <h3 class="text-center">
                    Bimbingan Teknis Penggiat Penggiat P4GN<br />
                    <span id="currentYear"></span>
                </h3>
                <hr />
            </div>
            <div class="action-button">
                <div class="d-flex justify-content-end mb-3 gap-2">
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#exportData"><i
                            class="fas fa-file-export me-2"></i>Ekspor Data</button>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModal"><i
                            class="fas fa-plus me-2"></i>Tambah Data</button>
                </div>
            </div>
            <div class="table-responsive">
                {% include 'psm/bimtek_penggiat_p4gn/table.html' %}
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block js_tambahan %}
<script src="{% static 'assets/dashboard/vendor/libs/jquery-repeater/jquery-repeater.js' %}"></script>
<script src="{% static 'assets/dashboard/js/bawaan/forms-extras.js' %}"></script>
<script type="text/javascript" src="https://oss.sheetjs.com/sheetjs/xlsx.full.min.js"></script>

<script>
    const { createApp, ref, onMounted, computed } = Vue;
    createApp({
        setup() {
            let dataKegiatan = ref(null);
            let satkerLevel = parseInt('{{ user.profile.satker.level }}');
            let perPage = ref(10);
            let currentPage = ref(1);
            let searchField = ref(null);
            let filteredPage = ref(null);

            const totalPage = computed(() => {
                if (dataKegiatan.value) {
                    return Math.ceil(dataKegiatan.value.length / perPage.value);
                }
                else return 0;
            });

            const pagedData = computed(() => {
                if (filteredPage.value) {
                    d = filteredPage.value.slice((currentPage.value - 1) * perPage.value, (currentPage.value) * perPage.value);
                    return d;
                }
                else return [];
            });

            function searchData(e) {
                filteredPage.value = dataKegiatan.value.filter((data) => {
                    idx = String(data.satker.toUpperCase());
                    nama_lingkungan = String(data.nama_lingkungan.toUpperCase());
                    tanggal_awal = String(data.tanggal_awal);
                    tanggal_akhir = String(data.tanggal_akhir);
                    hasil_capaian = String(data.hasil_capaian.toUpperCase());
                    kendala = String(data.kendala.toUpperCase());
                    kesimpulan = String(data.kesimpulan.toUpperCase());
                    tindak_lanjut = String(data.tindak_lanjut.toUpperCase());

                    bool1 = idx.indexOf(searchField.value.toUpperCase()) > -1;
                    bool2 = nama_lingkungan.indexOf(searchField.value.toUpperCase()) > -1;
                    bool3 = hasil_capaian.indexOf(searchField.value.toUpperCase()) > -1;
                    bool4 = kendala.indexOf(searchField.value.toUpperCase()) > -1;
                    bool5 = kesimpulan.indexOf(searchField.value.toUpperCase()) > -1;
                    bool6 = tindak_lanjut.indexOf(searchField.value.toUpperCase()) > -1;
                    bool7 = tanggal_awal.indexOf(searchField.value.toUpperCase()) > -1;
                    bool8 = tanggal_akhir.indexOf(searchField.value.toUpperCase()) > -1;
                    return bool1 || bool2 || bool3 || bool4 || bool5 || bool6 || bool7 || bool8;
                });
            };

            function hideableButton(status, satkerLevel, type) {
                if (type == 'kirim') {
                    return satkerLevel != 2 && ((satkerLevel == 0 && status < 2) || (satkerLevel == 1 && status < 1));
                } else if (type == 'edit') {
                    return satkerLevel == 2 || ((satkerLevel == 0 && status < 2) || (satkerLevel == 1 && status < 1));
                }
            }

            const apiURL = (satkerLevel == 1 ? '/kegiatan/api/v1/psm/bimtek_penggiat_p4gn/get_data_bnnk/?format=datatables' : '/kegiatan/api/v1/psm/bimtek_penggiat_p4gn/?format=datatables')

            function loadData() {
                tableContent = [];

                axios.get(apiURL).then(function (response) {
                    data = response.data.data;
                    for ([key, value] of Object.entries(data)) {
                        if (value.data && value.data.length > 0) {
                            baris = {
                                'class': 'table-primary',
                                'hide_satker': false,
                                'index': parseInt(key) + 1,
                                'satker': value.satker.nama_satker + '(' + value.data.length + ' kegiatan)',
                                'tanggal': '',
                                'nama_lingkungan': '',
                                'peserta_bimtek': '',
                                'peserta': '',
                                'hasil_capaian': '',
                                'kendala': '',
                                'kesimpulan': '',
                                'tindak_lanjut': '',
                                'status': '',
                                'type': 'parent'
                            };
                            tableContent.push(baris);
                            for ([key2, value2] of Object.entries(value.data)) {
                                let peserta = value2.peserta;
                                let peserta_bimtek = value2.peserta_bimtek;
                                let jumlahPerempuan = peserta_bimtek.filter(peserta => peserta.jenis_kelamin === "P").length;
                                let jumlahLelaki = peserta_bimtek.filter(peserta => peserta.jenis_kelamin === "L").length;
                                baris = {
                                    'class': '',
                                    'hide_satker': true,
                                    'index': (parseInt(key) + 1) + '.' + (parseInt(key2) + 1),
                                    'id': value2.id,
                                    'satker': value2.satker.nama_satker,
                                    'tanggal': (value2.tanggal_akhir) ? value2.tanggal_awal + ' s/d ' + value2.tanggal_akhir : value2.tanggal_awal,
                                    'nama_lingkungan': value2.nama_lingkungan,
                                    'seri_pin_penggiat': value2.seri_pin_penggiat,
                                    'peserta': peserta,
                                    'peserta_bimtek': peserta_bimtek,
                                    'jumlah_peserta_bimtek': peserta_bimtek.length,
                                    'L': jumlahLelaki,
                                    'P': jumlahPerempuan,
                                    'hasil_capaian': value2.hasil_capaian,
                                    'kendala': value2.kendala,
                                    'kesimpulan': value2.kesimpulan,
                                    'tindak_lanjut': value2.tindak_lanjut,
                                    'dokumentasi': value2.dokumentasi,
                                    'status': value2.status,
                                    'level': value2.satker.level,
                                    'type': 'first__child',
                                    'kirim': hideableButton(value2.status, satkerLevel, 'kirim'),
                                    'edit': hideableButton(value2.status, satkerLevel, 'edit'),
                                };
                                tableContent.push(baris);
                            }
                        }
                        if (value.detail !== undefined && value.detail.length > 0) {
                            for ([key3, value3] of Object.entries(value.detail)) {
                                baris = {
                                    'class': 'table-secondary',
                                    'hide_satker': false, 'index': (parseInt(key) + 1) + '.' + (parseInt(key2) + 1) + '.' + (parseInt(key3) + 1),
                                    'satker': value3.satker.nama_satker + '(' + value3.data.length + ' kegiatan)',
                                    'tanggal': '',
                                    'nama_lingkungan': '',
                                    'peserta': '',
                                    'peserta_bimtek': '',
                                    'hasil_capaian': '',
                                    'kendala': '',
                                    'kesimpulan': '',
                                    'tindak_lanjut': '',
                                    'status': '',
                                    'type': 'parent'
                                };
                                tableContent.push(baris);
                                for ([key4, value4] of Object.entries(value3.data)) {
                                    let peserta = value4.peserta;
                                    let peserta_bimtek = value4.peserta_bimtek;
                                    let jumlahPerempuan = peserta_bimtek.filter(peserta => peserta.jenis_kelamin === "P").length;
                                    let jumlahLelaki = peserta_bimtek.filter(peserta => peserta.jenis_kelamin === "L").length;
                                    baris = {
                                        'class': '',
                                        'hide_satker': true,
                                        'index': (parseInt(key) + 1) + '.' + (parseInt(key2) + 1) + '.' + (parseInt(key3) + 1) + '.' + (parseInt(key4) + 1),
                                        'id': value4.id,
                                        'satker': value4.satker.nama_satker,
                                        'tanggal': (value4.tanggal_akhir) ? value4.tanggal_awal + ' s/d ' + value4.tanggal_akhir : value4.tanggal_awal,
                                        'nama_lingkungan': value4.nama_lingkungan,
                                        'seri_pin_penggiat': value4.seri_pin_penggiat,
                                        'peserta': peserta,
                                        'peserta_bimtek': peserta_bimtek,
                                        'jumlah_peserta_bimtek': peserta_bimtek.length,
                                        'L': jumlahLelaki,
                                        'P': jumlahPerempuan,
                                        'hasil_capaian': value4.hasil_capaian,
                                        'kendala': value4.kendala,
                                        'kesimpulan': value4.kesimpulan,
                                        'tindak_lanjut': value4.tindak_lanjut,
                                        'dokumentasi': value2.dokumentasi,
                                        'level': value4.satker.level,
                                        'status': value4.status,
                                        'type': 'second__child',
                                        'kirim': hideableButton(value4.status, satkerLevel, 'kirim'),
                                        'edit': hideableButton(value4.status, satkerLevel, 'edit'),
                                    };
                                    tableContent.push(baris);
                                }
                            }
                        }
                    }
                    dataKegiatan.value = tableContent;
                    filteredPage.value = dataKegiatan.value;
                });
            }

            async function handleDelete(id) {
                const confirmationText = `Untuk menghapus data tersebut? <br> Data yang dihapus tidak dapat <b>dipulihkan</b> kembali`;
                const confirmResult = await showSwalConfirm(confirmationText, 'Ya, hapus data');
                if (!confirmResult.isConfirmed) return;
                showSwalLoading();
                await sleep(1000);
                try {
                    const response = await axios.delete(
                        `/kegiatan/api/v1/psm/bimtek_penggiat_p4gn/perform_delete/?id=${id}`
                    ).then(function (response) {
                        Swal.fire({
                            title: 'Berhasil!',
                            html: `Data kegiatan berhasil <b>dihapus</b>`,
                            icon: 'success',
                            confirmButtonText: 'OK',
                        }).then((result) => {
                            if (result.isConfirmed) {
                                location.reload()
                            }
                        });
                    });
                } catch (error) {
                    console.log('Terjadi kesalahan : ', error);
                    showSwalGenericError();
                }
            }

            async function handleEditModal(id) {
                try {
                    const response = await axios.get(`/kegiatan/api/v1/psm/bimtek_penggiat_p4gn/get_detail_data/?id=${id}`);
                    const data = response.data;

                    $('#edit__id').val(data[0].id);
                    $('#edit__tanggal_awal').val(data[0].tanggal_awal);
                    $('#edit__tanggal_akhir').val(data[0].tanggal_akhir);
                    $('#edit__satker').val(data[0].satker_id).trigger('change');
                    $('#edit__nama_lingkungan').val(data[0].nama_lingkungan)
                    $('#edit__seri_pin_penggiat').val(data[0].seri_pin_penggiat)
                    $('#edit__hasil_capaian').val(data[0].hasil_capaian);
                    $('#edit__kendala').val(data[0].kendala);
                    $('#edit__kesimpulan').val(data[0].kesimpulan);
                    $('#edit__tindak_lanjut').val(data[0].tindak_lanjut);

                    var formRepeaterPeserta = $('.edit__form-repeater.edit__peserta');
                    var formRepeaterPeserta_bimtek = $('.edit__form-repeater.edit__peserta_bimtek');
                    formRepeaterPeserta.repeater({
                        show: function () {
                            $(this).slideDown();
                        },
                        hide: function (deleteElement) {
                            $(this).slideUp(deleteElement);
                        }
                    });
                    formRepeaterPeserta_bimtek.repeater({
                        show: function () {
                            $(this).slideDown();
                        },
                        hide: function (deleteElement) {
                            $(this).slideUp(deleteElement);
                        }
                    });

                    var list_peserta = [];
                    var list_pesertaBimtek = [];
                    data[0].peserta.forEach(function (peserta) {
                        list_peserta.push({
                            'peserta_nama': peserta.nama,
                            'peserta_jabatan': peserta.jabatan,
                        });
                    });
                    data[0].peserta_bimtek.forEach(function (peserta) {
                        list_pesertaBimtek.push({
                            'pesertaBimtek_nama': peserta.nama,
                            'pesertaBimtek_alamat': peserta.alamat,
                            'pesertaBimtek_noTelp': peserta.no_telepon,
                            'pesertaBimtek_jenis_kelamin': peserta.jenis_kelamin,
                        });
                    });
                    formRepeaterPeserta.setList(list_peserta);
                    formRepeaterPeserta_bimtek.setList(list_pesertaBimtek);

                    formRepeaterPeserta.find('[data-repeater-create]').off('click').on('click', function () {
                        var newItem = formRepeaterPeserta.find('[data-repeater-item]').first().clone();
                        newItem.find('input').val('');
                        newItem.hide()
                        formRepeaterPeserta.find('[data-repeater-list]').append(newItem)
                        newItem.slideDown();
                    });

                    formRepeaterPeserta_bimtek.find('[data-repeater-create]').off('click').on('click', function () {
                        var newItem = formRepeaterPeserta_bimtek.find('[data-repeater-item]').first().clone();
                        newItem.find('input').val('');
                        newItem.hide()
                        formRepeaterPeserta_bimtek.find('[data-repeater-list]').append(newItem)
                        newItem.slideDown();
                    });
                    $('#editModal').modal('show');
                } catch (error) {
                    showSwalGenericError();
                    console.error('Terjadi kesalahan :', error);
                }
            }

            async function handleKirim(satker, id) {
                const confirmResult = await showSwalConfirm(`Apakah anda yakin untuk mengirim data kegiatan dari Satuan Kerja <b>${satker}</b>`, 'Ya, kirim data');
                if (!confirmResult.isConfirmed) return;
                showSwalLoading();
                await sleep(1000);
                try {
                    const response = await axios.post(
                        `/kegiatan/api/v1/psm/bimtek_penggiat_p4gn/kirim_kegiatan/`,
                        { id: id }
                    ).then(function (response) {
                        const sendedToParent = response.data.parent.keterangan;
                        Swal.fire({
                            title: 'Berhasil!',
                            html: `Data <b>kegiatan</b> untuk <b>${satker}</b> telah berhasil <b>dikirimkan ke ${sendedToParent}</b>`,
                            icon: 'success',
                            confirmButtonText: 'OK',
                        }).then((result) => {
                            if (result.isConfirmed) {
                                location.reload()
                            }
                        });
                    });
                } catch (error) {
                    showSwalGenericError();
                    console.error('Terjadi kesalahan :', error);
                }
            }

            const daftarPeserta = ref({});
            function modalPeserta(data, satker) {
                daftarPeserta.value = data

                $('#detailPeserta').modal('show');
                $('#detailPeserta #detail__info').text(satker)
            }
            const daftarPeserta_bimtek = ref({});
            function modalPeserta_bimtek(data, satker) {
                daftarPeserta_bimtek.value = data

                $('#detailPesertaBimtekModal').modal('show');
                $('#detailPesertaBimtekModal #detail__info').text(satker)
            }

            onMounted(() => {
                loadData();
            });

            return {
                dataKegiatan,
                satkerLevel,
                loadData,
                handleDelete,
                handleEditModal,
                handleKirim,
                modalPeserta,
                daftarPeserta,
                modalPeserta_bimtek,
                daftarPeserta_bimtek,
                totalPage,
                perPage,
                currentPage,
                pagedData,
                searchData,
                searchField
            }
        },
        delimiters: ['${', '}']
    }).mount('#app')
</script>

<script>
    async function handlePost(e) {
        e.preventDefault();
        showSwalLoading()

        const tanggal_awal = $("#create__tanggal_awal").val();
        const tanggal_akhir = $("#create__tanggal_akhir").val();
        const satker = parseInt($("#create__satker").val());
        const nama_lingkungan = $("#create__nama_lingkungan").val();
        const seri_pin_penggiat = $("#create__seri_pin_penggiat").val();
        const hasil_capaian = $("#create__hasil_capaian").val();
        const kendala = $("#create__kendala").val();
        const kesimpulan = $("#create__kesimpulan").val();
        const tindak_lanjut = $("#create__tindak_lanjut").val();
        const dokumentasi = $("#create__dokumentasi")[0].files[0];
        const peserta = [];
        const peserta_bimtek = [];

        const data = [
            tanggal_awal,
            tanggal_akhir,
            satker,
            nama_lingkungan,
            seri_pin_penggiat,
            hasil_capaian,
            kendala,
            kesimpulan,
            tindak_lanjut,
            dokumentasi,
            peserta,
            peserta_bimtek,
        ];

        console.log(data);

        $('.form-repeater.create.peserta [data-repeater-item]').each(function (index, element) {
            peserta.push({
                nama: $(element).find('[id^="form-repeater"]').eq(0).val(),
                jabatan: $(element).find('[id^="form-repeater"]').eq(1).val(),
            });
        });
        $('.form-repeater.create.peserta_bimtek [data-repeater-item]').each(function (index, element) {
            peserta_bimtek.push({
                nama: $(element).find('[id^="form-repeater"]').eq(0).val(),
                alamat: $(element).find('[id^="form-repeater"]').eq(1).val(),
                no_telepon: $(element).find('[id^="form-repeater"]').eq(2).val(),
                jenis_kelamin: $(element).find('[id^="form-repeater"]').eq(3).val(),
            });
        });

        const formData = new FormData();

        formData.append("tanggal_awal", tanggal_awal);
        formData.append("tanggal_akhir", tanggal_akhir);
        formData.append("satker", parseInt(satker));
        formData.append("nama_lingkungan", nama_lingkungan);
        formData.append("seri_pin_penggiat", seri_pin_penggiat);
        formData.append("hasil_capaian", hasil_capaian);
        formData.append("kendala", kendala);
        formData.append("kesimpulan", kesimpulan);
        formData.append("tindak_lanjut", tindak_lanjut);
        formData.append("dokumentasi", dokumentasi);
        formData.append("peserta", JSON.stringify(peserta));
        formData.append("peserta_bimtek", JSON.stringify(peserta_bimtek));

        try {
            axios.post('/kegiatan/api/v1/psm/bimtek_penggiat_p4gn/perform_create/', formData, {
                headers: {
                    'Content-Type': 'multipart/form-data'
                }
            }).then(function (response) {
                Swal.fire({
                    title: 'Berhasil!',
                    html: `Data kegiatan telah <b>berhasil</b> ditambahkan!`,
                    icon: 'success',
                    confirmButtonText: 'OK',
                }).then((result) => {
                    if (result.isConfirmed) {
                        location.reload()
                    }
                });
            });
        } catch (error) {
            showSwalGenericError();
            console.error("Terjadi kesalahan :", error);
        }
    };

    const phone = document.querySelector('.cleave-phone');
    phone && new Cleave(phone, {
        phone: true,
        phoneRegionCode: "ID",
    });

    async function handleEdit(e) {
        e.preventDefault();
        showSwalLoading();

        const id = $('#edit__id').val();
        const tanggal_awal = $("#edit__tanggal_awal").val();
        const tanggal_akhir = $("#edit__tanggal_akhir").val();
        const satker = $("#edit__satker").val();
        const nama_lingkungan = $("#edit__nama_lingkungan").val();
        const seri_pin_penggiat = $("#edit__seri_pin_penggiat").val();
        const hasil_capaian = $("#edit__hasil_capaian").val();
        const kendala = $("#edit__kendala").val();
        const kesimpulan = $("#edit__kesimpulan").val();
        const tindak_lanjut = $("#edit__tindak_lanjut").val();
        const dokumentasi = $("#edit__dokumentasi")[0].files[0];
        const peserta = [];
        const peserta_bimtek = [];

        $('.edit__form-repeater.edit__peserta [data-repeater-item]').each(function (index, element) {
            peserta.push({
                nama: $(element).find('[id^="form-repeater"]').eq(0).val(),
                jabatan: $(element).find('[id^="form-repeater"]').eq(1).val(),
            });
        });
        $('.edit__form-repeater.edit__peserta_bimtek [data-repeater-item]').each(function (index, element) {
            peserta_bimtek.push({
                nama: $(element).find('[id^="form-repeater"]').eq(0).val(),
                alamat: $(element).find('[id^="form-repeater"]').eq(1).val(),
                no_telepon: $(element).find('[id^="form-repeater"]').eq(2).val(),
                jenis_kelamin: $(element).find('[id^="form-repeater"]').eq(3).val(),
            });
        });

        const formData = new FormData();

        formData.append("id", id);
        formData.append("tanggal_awal", tanggal_awal);
        formData.append("tanggal_akhir", tanggal_akhir);
        formData.append("satker", parseInt(satker));
        formData.append("nama_lingkungan", nama_lingkungan);
        formData.append("seri_pin_penggiat", seri_pin_penggiat);
        formData.append("hasil_capaian", hasil_capaian);
        formData.append("kendala", kendala);
        formData.append("kesimpulan", kesimpulan);
        formData.append("tindak_lanjut", tindak_lanjut);
        formData.append("peserta", JSON.stringify(peserta));
        formData.append("peserta_bimtek", JSON.stringify(peserta_bimtek));
        if (dokumentasi) { formData.append('dokumentasi', dokumentasi); }

        try {
            const response = await axios.patch(
                `/kegiatan/api/v1/psm/bimtek_penggiat_p4gn/perform_update/`, formData, {
                headers: {
                    "Content-Type": "multipart/form-data",
                },
            }).then(function (response) {
                $("#editModal").modal("hide");
                Swal.fire({
                    title: 'Berhasil!',
                    html: `Data kegiatan telah <b>berhasil</b> diperbarui!`,
                    icon: 'success',
                    confirmButtonText: 'OK',
                }).then((result) => {
                    if (result.isConfirmed) {
                        location.reload()
                    }
                });
            });
        } catch (error) {
            showSwalGenericError();
            console.error("Terjadi kesalahan :", error);
        }
    }
</script>
{% endblock %}

{% block modal_tambahan %}
{% include 'psm/bimtek_penggiat_p4gn/modals/detail_peserta.html' %}
{% include 'psm/bimtek_penggiat_p4gn/modals/detail_peserta_bimtek.html' %}
{% include 'psm/bimtek_penggiat_p4gn/modals/create.html' %}
{% include 'psm/bimtek_penggiat_p4gn/modals/edit.html' %}
{% endblock %}