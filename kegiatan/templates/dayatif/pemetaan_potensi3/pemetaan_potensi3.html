{% extends 'dashboard/dashboard_base.html' %}
{% load static %}
{% block title %} Rapat Kerja Teknis {% endblock %}
{% block content %}
<div class="breadcrumb">
    <div class="row">
        <h3 class="heading mb-2">Pemetaan Potensi</h3>
        <span class="mb-0">
            <span class="text-muted fw-light">Kegiatan /</span>
            <span class="ms-1 fw-medium">Pemetaan Potensi</span>
        </span>
    </div>
</div>

<section>
    <div class="card">
        <div class="card-body">
            <div id="headline" class="mb-3">
                <h3 class="text-center">
                    PEMETAAN POTENSI SDM DAN SDA KAWASAN RAWAN NARKOBA <br />
                    <span id="currentYear"></span>
                </h3>
                <hr />
            </div>

            <div class="action-button">
                <div class="d-flex justify-content-end mb-3 gap-2">
                    <button class="btn btn-success" data-bs-toggle="modal" onclick="handleExport()">
                        <i class="fas fa-file-export me-2"></i>Ekspor Data
                    </button>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModal">
                        <i class="fas fa-plus me-2"></i>Tambah Data
                    </button>
                </div>
            </div>

            <div class="row d-flex justify-content-end my-5">
                <div class="col-lg-3">
                    <div class="mb-3">
                        <label for="" class="form-label">Pencarian</label>
                        <input type="text" class="form-control"@input="handleSearch()" />
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered" id="__table">
                    <thead>
                        <tr>
                            <th class="bg-soft-success text-center">No.</th>
                            <th class="bg-soft-success">Satuan Kerja Pelaksana</th>
                            <th class="bg-soft-success">Tanggal</th>
                            <th class="bg-soft-success">Lokasi</th>
                            <th class="bg-soft-success">Deskripsi Hasil</th>
                            <th class="bg-soft-success">Hambatan/Kendala</th>
                            <th class="bg-soft-success">Kesimpulan</th>
                            <th class="bg-soft-success">Tindak Lanjut</th>
                            <th class="bg-soft-success">Dokumentasi</th>
                            <th class="bg-soft-success" style="max-width: 150px">Aksi <i class="fas fa-edit ms-2"></i></th>
                        </tr>
                    </thead>
                    <tbody class="align-tr-middle text-white">
                        <template v-for="(topLevel, index) in tableData">
                            <tr class="bg-soft-danger">
                                <td>${index+1}</td>
                                <td colspan="8">${topLevel.satker.nama_satker} (${ topLevel.data.length } kegiatan)</td>
                                <td>
                                    <v-parent-action-button @refresh="loadData" @update="(value) => statusPengirimanSemua = value" :satker="topLevel.satker.id" :satkerlevel="satkerLevel" :status="statusPengirimanSemua" />
                                </td>
                            </tr>
                            <template v-for="(secondLevel, index2) in topLevel.data ">
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td>${secondLevel.tanggal_awal}-<br />${secondLevel.tanggal_akhir}</td>
                                    <td>
                                        <v-lokasi :provnisi="secondLevel.provinsi" :kabupaten="secondLevel.kabupaten" :kecamatan="secondLevel.kecamatan" :desa="secondLevel.desa"></v-lokasi>
                                    </td>
                                    <td>${secondLevel.deskripsi}</td>
                                    <td>${secondLevel.kendala}</td>
                                    <td>${secondLevel.kesimpulan}</td>
                                    <td>${secondLevel.tindak_lanjut}</td>
                                    <td>
                                        <div class="text-center">
                                            <a :href="secondLevel.dokumen" class="badge bg-primary text-white" target="_blank">
                                            <i class="fas fa-eye me-2"></i>
                                            Lihat dokumentasi
                                            </a>
                                        </div>
                                    </td>
                                    <td v-html="getChildActionBTN(secondLevel.id, secondLevel.status)"></td>

                                    <!-- <v-child-action-button :id="secondLevel.id"
                                        :status="secondLevel.status"
                                        :satkerlevel="satkerLevel"  /> -->
                                </tr>
                            </template>
                            <template v-if="topLevel.detail.length > 0">
                                <template v-for="(thirdLevel, index3) in topLevel.detail">
                                    <tr class="bg-soft-gray">
                                        <td>${index+1}.${index3+1}</td>
                                        <td colspan="8">${thirdLevel.satker.nama_satker} (${thirdLevel.data.length}
                                            kegiatan)</td>
                                        <td>
                                            <v-parent-action-button @refresh="loadData" @update="((value) => statusPengirimanSemua = value) " :satker="thirdLevel.satker.id" :satkerlevel="satkerLevel" :status="statusPengirimanSemua" />
                                        </td>
                                    </tr>
                                    <template v-for="(fourthLevel, index) in thirdLevel.data">
                                        <tr>
                                            <td></td>
                                            <td></td>
                                            <td>${fourthLevel.tanggal_awal}-<br />${fourthLevel.tanggal_akhir}</td>
                                            <td>
                                                <v-lokasi :provnisi="fourthLevel.provinsi" :kabupaten="fourthLevel.kabupaten" :kecamatan="fourthLevel.kecamatan" :desa="fourthLevel.desa"></v-lokasi>
                                            </td>
                                            <td>${fourthLevel.deskripsi}</td>
                                            <td>${fourthLevel.kendala}</td>
                                            <td>${fourthLevel.kesimpulan}</td>
                                            <td>${fourthLevel.tindak_lanjut}</td>
                                            <td>
                                                <div class="text-center">
                                                    <a :href="fourthLevel.dokumen" class="badge bg-primary text-white" target="_blank">
                                                    <i class="fas fa-eye me-2"></i>
                                                    Lihat dokumentasi
                                                    </a>
                                                </div>
                                            </td>
                                            <td v-html="getChildActionBTN(fourthLevel.id, fourthLevel.status)"></td>
                                            <!-- <td>
                                                <v-child-action-button :id="fourthLevel.id"
                                                :status="fourthLevel.status"
                                                :satkerlevel="satkerLevel"  /> -->
                                        </tr>
                                    </template>
                                </template>
                                
                            </template>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block js_tambahan %}
<script type="text/javascript" src="https://oss.sheetjs.com/sheetjs/xlsx.full.min.js"></script>

<script>
    // console.log('Satker level :', satkerLevel)
    // console.log('Status pengiriman semua :', statusPengirimanSemua)

    const {
        createApp,
        ref,
        onMounted,
        defineEmits,
    } = Vue;

    const Lokasi =  {
        name: 'Lokasi',
        props: ['provinsi', 'kabupaten', 'kecamatan', 'desa'],
        template: `
            <ul class="location__list">
                <li><span class="location__label">Provinsi</span>:<span class="location__value">{{ provinsi }}</span></li>
                <li><span class="location__label">Kabupaten/Kota</span>:<span class="location__value">{{ kabupaten }}</span></li>
                <li><span class="location__label">Kecamatan</span>:<span class="location__value">{{ kecamatan }}</span></li>
                <li><span class="location__label">Desa/Kelurahan</span>:<span class="location__value">{{ desa }}</span></li>
            </ul>
        `
    };

    const ParentActionBTN = {
        name: 'ParentActionBTN',
        props: ['satker', 'satkerlevel', 'status'],
        template: `
            <div class="list-button gx-3 text-uppercase">
                <a href="javascript:;" @click="handleSemua('kirim')"
                    :class="{ 'badge bg-primary text-white text-decoration-none mb-1': !status, 'badge bg-secondary text-white text-decoration-none mb-1': status }">
                    <i class="fas fa-paper-plane me-2"></i>Kirim Semua
                </a>
                <a href="javascript:;" @click="handleSemua('batalkan')" class="badge bg-warning text-white text-decoration-none text-uppercase mb-1">
                    <i class="fas fa-ban me-2"></i>Batalkan Semua Pengiriman
                </a>
                <a href="javascript:;"
                    class="text-white text-decoration-none mb-1"
                    :class="{'badge': true, 'bg-danger': isDeletable(), 'bg-secondary': !isDeletable()}"
                    @click="isDeletable() ? handleDeleteAllKegiatan() : null">
                        <i class="fas fa-trash-alt me-2"></i>Hapus Semua
                    </a>
            </div>
        `,
        methods: {
            isDeletable() {
                return (this.satkerlevel == 0 || this.satkerLevel == 2);
            },
            async handleSemua(tipe) {
                let satker_id = null;
                let nama_satker = '';
                let payload = { tipe };

                const isNumeric = !isNaN(this.satker);

                if (isNumeric) {
                    satker_id = this.satker;
                    payload['satker_id'] = satker_id;
                } else {
                    nama_satker = this.satker;
                    payload['nama_satker'] = nama_satker;
                }

                const satkerInfo = nama_satker == '' ? 'Satuan Kerja' : nama_satker;

                const confirmMessage = tipe == 'kirim' ? `Apakah anda yakin untuk mengirim semua kegiatan dari <b>${satkerInfo}</b>` : `Apakah anda yakin untuk membatalkan semua pengiriman kegiatan dari <b>${satkerInfo}</b>`;

                const confirmMessageButton = tipe == 'kirim' ? 'Ya, kirim data' : 'Ya, batalkan';

                const confirmResult = await showSwalConfirm(`${confirmMessage}?`, confirmMessageButton);

                if (!confirmResult.isConfirmed) return;

                showSwalLoading();

                await sleep(1000);

                try {
                    const response = await axios.post('/kegiatan/api/v1/dayatif/pemetaan_potensi/semua_kegiatan/', payload);

                    console.log('Respose :', response);

                    const sendedToParent = response.data.parent.keterangan;

                    const successMessage = tipe == 'kirim' ? `Data <b>kegiatan</b> dari <b>${satkerInfo}</b> telah berhasil <b>dikirimkan ke <b>${sendedToParent}</b></b>` : `Data pengiriman <b>kegiatan</b> ke <b>${sendedToParent}</b> dari <b>${satkerInfo}</b> telah berhasil <b>dibatalkan</b>`

                    showSwalSuccess('Berhasil', successMessage);

                    this.$emit('refresh');

                    const value = tipe == 'kirim';

                    this.$emit('update', value);
                    
                    tipe == 'kirim' ?? $('#kirimSemuaBTN').addClass('disabled bg-secondary').removeClass('bg-primary')
                    ;
                } catch (error) {
                    showSwalGenericError();
                    console.error('Terjadi kesalahan :', error);
                }
            },
            async handleDeleteAllKegiatan() {
                const confirmResult = await showSwalConfirm(`Untuk menghapus data <b>kegiatan</b>? <br> Data yang dihapus tidak dapat <b>dipulihkan</b> kembali`, 'Ya, hapus data');

                if (!confirmResult.isConfirmed) return;

                showSwalLoading();

                await sleep(1000);

                try {
                    const response = await axios.delete(`/kegiatan/api/v1/dayatif/pemetaan_potensi/${this.satker}/delete_all_kegiatan/`);
                    console.log('Respose :', response);
                    
                    showSwalSuccess('Berhasil', `Data <b>kegiatan</b> telah berhasil <b>dihapus</b>`, 3000);
                    
                    this.$emit('refresh');
                } catch (error) {
                    showSwalGenericError();
                    console.error('Terjadi kesalahan :', error);
                }
            }
        }
    };
    
    const ChildActionBTN = {
        name: 'ChildActionBTN',
        props: ['id', 'status', 'satkerlevel'],
        computed: {
            kirimArgs() {
                return this.getKirimArgs();
            },
            deleteArgs() {
                return this.getDeleteArgs();
            },
            editBTN() {
                return 'sasa'
                return this.getEditBTN();
            },
            kirimBTN() {
                return this.getKirimBTN();
            },
            deleteBTN() {
                return this.getDeleteBTN();
            },
        },
        template: `
            <div class="list-button gx-3 text-uppercase">
                ${this.satkerlevel < 2 ? this.kirimBTN : ''}
                ${this.editBTN}
                ${this.deleteBTN}
            </div>
        `,
        methods: {
            getDeleteArgs() {
                return JSON.stringify({
                    id: this.id,
                    name: 'kegiatan',
                    apiURL: '/kegiatan/api/v1/dayatif/pemetaan_potensi'
                });
            },
            getKeterangan() {
                const keteranganStatusList = {
                    0: 'BNNP',
                    1: 'Pusat'
                };
                return keteranganStatusList[this.status] || '?';
            },
            getKirimArgs() {
                return JSON.stringify({
                    id: this.id,
                    nama_satker: '',
                    keterangan: this.getKeterangan()
                });
            },
            isKirimable() {
                return this.satkerlevel != 2 && ((this.satkerlevel == 0 && this.status < 2) || (this.satkerlevel == 1 && this.status < 1));
            },
            isEditable() {
                return this.satkerlevel == 2 || ((this.satkerlevel == 0 && this.status < 2) || (this.satkerlevel == 1 && this.status < 1));
            },
            getKirimBTN() {
                return this.isKirimable() ? `<div>
                    <a href="javascript:void(0);" onclick='handleKirim(${this.kirimArgs}, ${this.id})' class="badge bg-primary text-white text-decoration-none mb-1"><i class="fas fa-paper-plane me-2"></i>Kirim</a>
                </div>` : `<div>
                    <a href="javascript:void(0);" class="badge bg-secondary text-white text-decoration-none mb-1"><i class="fas fa-paper-plane me-2"></i>Kirim</a>
                </div>`;
            },
            getEditBTN() {
                return this.isEditable() ? `<div>
                    <a href="javascript:void(0);" onclick="handleEdit(${this.id})" class="badge bg-success text-white text-decoration-none mb-1">
                        <i class="fas fa-pen-to-square me-2"></i>Edit</a>
                </div>` : `<div>
                    <a href="javascript:void(0);" class="badge bg-secondary text-white text-decoration-none mb-1">
                        <i class="fas fa-pen-to-square me-2"></i>Edit</a>
                </div>`;
            },
            getDeleteBTN() {
                return this.isEditable() ? `<div>
                    <a href="javascript:void(0);" onclick="handleDelete(${this.deleteArgs})" class="badge bg-danger text-white text-decoration-none mb-1">
                        <i class="fas fa-trash-alt me-2"></i>Hapus</a>
                </div>` : `<div>
                    <a href="javascript:void(0);" class="badge bg-secondary text-white text-decoration-none mb-1">
                        <i class="fas fa-trash-alt me-2"></i>Hapus</a>
                </div>`;
            }
        }
    };

    const app = createApp({
        delimiters: ['${', '}'],
        components: {
            'v-lokasi': Lokasi,
            'v-parent-action-button': ParentActionBTN,
            'v-child-action-button': ChildActionBTN,
        },
        setup() {
            const title = ref('Pemetaan Potensi');

            const satkerLevel = ref(parseInt('{{ user.profile.satker.level }}'));

            let tableData = ref(null);

            const loadData = async () => {
                const response = await axios.get('/kegiatan/api/v1/dayatif/pemetaan_potensi/list/?format=datatables');
                const data = response.data.data;

                data.forEach(item => {
                    if (item.detail.length == 0)
                        item.has_child = false;
                    else
                        item.has_child = true;
                })
                tableData.value = data;

                console.log('Initial Data:', tableData.value);
            };

            const getChildActionBTN = (id, status) => {
                const deleteArgs = JSON.stringify({
                    id: id,
                    name: 'kegiatan',
                    apiURL: '/kegiatan/api/v1/dayatif/pemetaan_potensi'
                });

                const keteraganStatusList = {
                    0: 'BNNP',
                    1: 'Pusat'
                };

                const keteranganKirim = keteraganStatusList[status] || '?';

                const kirimArgs = JSON.stringify({
                    id: id,
                    nama_satker: '',
                    keterangan: keteranganKirim
                });

                const isKirimable = satkerLevel != 2 && (satkerLevel == 0 && status < 2) || (satkerLevel == 1 && status < 1);

                const isEditable = satkerLevel == 2 || (satkerLevel == 0 && status < 2) || (satkerLevel == 1 && status < 1);

                const BTN = {};

                BTN.kirim = isKirimable ? `<div>
                    <a href="javascript:void(0);" onclick='handleKirim(${kirimArgs}, ${id})'
                        class="badge bg-primary text-white text-decoration-none mb-1"><i
                            class="fas fa-paper-plane me-2"></i>Kirim</a>
                </div>` : `<div>
                    <a href="javascript:void(0);" class="badge bg-secondary text-white text-decoration-none mb-1"><i
                            class="fas fa-paper-plane me-2"></i>Kirim</a>
                </div>`;

                BTN.edit = isEditable ? `<div>
                    <a href="javascript:void(0);" onclick="handleEdit(${id})"
                        class="badge bg-success text-white text-decoration-none mb-1">
                        <i class="fas fa-pen-to-square me-2"></i>Edit</a>
                </div>` : `<div>
                    <a href="javascript:void(0);" class="badge bg-secondary text-white text-decoration-none mb-1">
                        <i class="fas fa-pen-to-square me-2"></i>Edit</a>
                </div>`;

                BTN.delete = isEditable ? `<div>
                    <a href="javascript:void(0);" onclick="handleDelete(${deleteArgs})"
                        class="badge bg-danger text-white text-decoration-none mb-1">
                        <i class="fas fa-trash-alt me-2"></i>Hapus</a>
                </div>` : `<div>
                    <a href="javascript:void(0);" class="badge bg-secondary text-white text-decoration-none mb-1">
                        <i class="fas fa-trash-alt me-2"></i>Hapus</a>
                </div>`;

                const el = `
                    <div class="list-button gx-3 text-uppercase">
                        ${satkerLevel < 2 ? BTN.kirim : ''}
                        ${BTN.edit}
                        ${BTN.delete}
                    </div>`;

                return el;
            }

            const post = ref({
                provinsi: '',
                kabupaten: '',
                kecamatan: '',
                desa: ''
            });

            onMounted(async () => {
                await loadData();

                console.log('Satker level :', satkerLevel.value);
            });

            return {
                tableData,
                title,
                loadData,
                getChildActionBTN,
                post,
                onPostFileChange,

                satkerLevel,
                statusPengirimanSemua,
                setStatusPengirimanSemua,
            }
        },
    }).mount('#app')
</script>

<script>
    const API_LOKASI_URL = 'http://103.210.54.17:8003';
    let listProvinces = null;

    async function fetchDropdownData(url, id, dropdown, type, resetFunction) {
        if (!id) return;

        resetFunction();

        try {
            const response = await axios.get(url);

            response.data.forEach(value => {
                dropdown.append($('<option>', {
                    value: value.id,
                    text: value[`nama_${type}`]
                }));
            });

            dropdown.removeAttr('disabled');
        } catch (error) {
            console.error('Error:', error);
        }
    }

    const API_URLS = {
        regencies: API_LOKASI_URL + '/dashboard/masters/api/v1/list_regencies/?provinsi=',
        districts: API_LOKASI_URL + '/dashboard/masters/api/v1/list_districts/?kabupaten=',
        villages: API_LOKASI_URL + '/dashboard/masters/api/v1/list_villages/?kecamatan=',
        provinces: API_LOKASI_URL + '/dashboard/masters/api/v1/provinces/',
    };

    const dropdownOptions = {
        kabupaten: { resetFunction: resetKabupaten, url: API_URLS.regencies },
        kecamatan: { resetFunction: resetKecamatan, url: API_URLS.districts },
        desa: { resetFunction: resetDesa, url: API_URLS.villages }
    };

    async function loadDropdownData(type, id, dropdown) {
        const { resetFunction, url } = dropdownOptions[type];
        await fetchDropdownData(`${url}${id}`, id, dropdown, type, resetFunction);
    }

    async function fetchProvinsi() {
        try {
            const response = await axios.get(API_URLS.provinces);
            listProvinces = response.data.results;
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function assignProvinsi(type) {
        const provinsiDropdown = $(`#${type}__provinsi`);

        listProvinces.forEach(value => {
            provinsiDropdown.append($('<option>', {
                value: value.id,
                text: value.nama_provinsi
            }));
        });

        provinsiDropdown.removeAttr('disabled');
    }

    const semua_option = `<option value="">Semua</option>`;

    function resetKabupaten(type) {
        $(`#${type}__kabupaten`).empty();
        $(`#${type}__kabupaten`).append($(`<option>`, {
            value: '',
            text: '--Pilih kabupaten/kota--',
            disabled: true,
        }));
        $(`#${type}__kabupaten`).prop(`disabled`, true);
        $(`#${type}__kecamatan`).prop(`disabled`, true);

        $(`#${type}__kabupaten`).append(semua_option);
    }

    function resetKecamatan(type) {
        $(`#${type}__kecamatan`).empty();
        $(`#${type}__kecamatan`).append($('<option>', {
            value: '',
            text: '--Pilih kecamatan--',
            disabled: true
        }));
        $(`#${type}__kecamatan`).prop('disabled', true);
        $(`#${type}__kecamatan`).append(semua_option);
    }

    function resetDesa(type) {
        $(`#${type}__desa`).empty();
        $(`#${type}__desa`).append($('<option>', {
            value: '',
            text: '--Pilih desa/kelurahan--',
            disabled: true
        }));
        $(`#${type}__desa`).prop('disabled', true);
        $(`#${type}__desa`).append(semua_option);
    }

    $(function () {
        (async () => {
            try {
                await fetchProvinsi();
                await assignProvinsi('create');
                await assignProvinsi('edit');

                $('#create__provinsi, #edit__provinsi').on('change', async function () {
                    const value = $(this).val();
                    const type = $(this).attr('id').split('__')[0];

                    if (value && value !== '') {
                        await loadDropdownData('kabupaten', value, $(`#${type}__kabupaten`));
                    } else {
                        resetKabupaten(type);
                        resetKecamatan(type);
                        resetDesa(type);
                    }
                });

                $('#create__kabupaten, #edit__kabupaten').on('change', async function () {
                    const value = $(this).val();
                    const type = $(this).attr('id').split('__')[0];

                    if (value && value !== '') {
                        await loadDropdownData('kecamatan', value, $(`#${type}__kecamatan`));
                    } else {
                        resetKecamatan(type);
                        resetDesa(type);
                    }
                });

                $('#create__kecamatan, #edit__kecamatan').on('change', async function () {
                    const value = $(this).val();
                    const type = $(this).attr('id').split('__')[0];

                    if (value && value !== '') {
                        await loadDropdownData('desa', value, $(`#${type}__desa`));
                    } else {
                        resetDesa(type);
                    }
                });

            } catch (error) {
                console.error('Terjadi kesalahan saat memuat data statistik :', error);
            }
        })();
    });

    function formatDate(dateString) {
        const [year, month, day] = dateString.split('-');
        return new Date(year, month - 1, day);
    }

    function calculateDays() {

        this.startDate = this.startDate == '' ? (this.$refs.startDate.value) : this.startDate;
        this.endDate = this.endDate == '' ? (this.$refs.endDate.value) : this.endDate;

        // console.log('Start Date :', this.$refs.startDate.value);
        // console.log('End Date :', this.$refs.endDate.value);

        const startDate = formatDate(this.startDate);
        const endDate = formatDate(this.endDate);

        this.firstTime = true;

        // Clear end date if start date is cleared
        if (!this.startDate) {
            this.endDate = '';
            return;
        }

        // Prevent choosing end date less than current date
        const currentDate = new Date();
        if (startDate > endDate) {
            this.endDate = '';
            return;
        }

        if (endDate < currentDate) {
            alert('Tanggal akhir tidak boleh kurang dari tanggal saat ini!');
            this.endDate = '';
            return;
        }
    }
</script>

{% endblock %}
{% block modal_tambahan %}
{% include 'dayatif/pemetaan_potensi3/modals/create_modal.html'%}
{% include 'dayatif/pemetaan_potensi3/modals/edit_modal.html' %}
{% endblock %}