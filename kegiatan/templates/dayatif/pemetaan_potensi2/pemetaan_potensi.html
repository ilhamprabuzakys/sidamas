{% extends 'dashboard/dashboard_base.html' %}
{% load static %}
{% block title %} Pemetaan Potensi {% endblock %}
{% block content %}
<div class="breadcrumb">
    <div class="row">
        <h3 class="heading mb-2">Pemetaan Potensi</h3>
        <span class="mb-0">
            <span class="text-muted fw-light">Kegiatan /</span>
            <span class="ms-1 fw-medium">Pemetaan Potensi</span>
        </span>
    </div>
</div>

<section id="__data">
    <div class="card">
        <div class="card-body">
            <div id="headline" class="mb-3">
                <h3 class="text-center">
                    PEMETAAN POTENSI SDM DAN SDA KAWASAN RAWAN NARKOBA <br />
                    <span id="currentYear"></span>
                </h3>
                <hr />
            </div>

            <div class="action-button">
                <div class="d-flex justify-content-end mb-3 gap-2">
                    <button class="btn btn-success" data-bs-toggle="modal" onclick="handleExport()">
                        <i class="fas fa-file-export me-2"></i>Ekspor Data
                    </button>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModal">
                        <i class="fas fa-plus me-2"></i>Tambah Data
                    </button>
                    
                    <button class="btn btn-primary" @click="store.increment()">
                        <i class="fas fa-plus me-2"></i>Increment
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered" id="__table">
                    <thead>
                        <tr>
                            <th class="bg-soft-success text-center">
                                <i class="fas fa-circle-chevron-up"></i>
                                No.
                            </th>
                            <th class="bg-soft-success">Satuan Kerja Pelaksana</th>
                            <th class="bg-soft-success">Tanggal</th>
                            <th class="bg-soft-success">Lokasi</th>
                            <th class="bg-soft-success">Deskripsi Hasil</th>
                            <th class="bg-soft-success">Hambatan/Kendala</th>
                            <th class="bg-soft-success">Kesimpulan</th>
                            <th class="bg-soft-success">Tindak Lanjut</th>
                            <th class="bg-soft-success">Dokumentasi</th>
                            <th class="bg-soft-success" style="max-width: 150px">Aksi <i class="fas fa-edit ms-2"></i></th>
                        </tr>
                    </thead>
                    <tbody class="align-tr-middle text-white">
                        <!-- Level 1 -->
                        <template v-for="(topLevel, index) in tableData">
                            <tr class="bg-soft-danger">
                                <td>{ index+1 }</td>
                                <td colspan="8"><v-section-header :satker='topLevel.satker.nama_satker' :jumlah="topLevel.data.length" /></td>
                                <td>
                                </td>
                            </tr>
                            <!-- Level 2 -->
                            <template v-for="(secondLevel, index2) in topLevel.data ">
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td>
                                        { secondLevel.tanggal_awal } s/d { secondLevel.tanggal_akhir }
                                    </td>
                                    <td>
                                        <v-lokasi :provinsi="secondLevel.nama_provinsi" :kabupaten="secondLevel.nama_kabupaten" :kecamatan="secondLevel.nama_kecamatan" :desa="secondLevel.nama_desa"></v-lokasi>
                                    </td>
                                    <td>{ secondLevel.deskripsi }</td>
                                    <td>{ secondLevel.kendala }</td>
                                    <td>{ secondLevel.kesimpulan }</td>
                                    <td>{ secondLevel.tindak_lanjut }</td>
                                    <td>
                                        <div class="text-center">
                                            <a :href="secondLevel.dokumentasi" class="badge bg-primary text-white cursor-pointer" target="_blank">
                                            <i class="fas fa-eye me-2"></i>
                                            Lihat dokumentasi
                                            </a>
                                        </div>
                                    </td>
                                    
                                    <!-- Action BTN -->
                                    <td>
                                        <div>
                                            <a href="javascript:void(0);" class="badge bg-primary text-white text-decoration-none mb-1">
                                              <i class="fa-regular fa-paper-plane me-2"></i>Kirim
                                            </a>
                                          </div>
                                          <div>
                                            <a href="javascript:void(0);" @click="handleEdit(secondLevel.id)"
                                              class="badge bg-success text-white text-decoration-none mb-1">
                                              <i class="fas fa-pen-to-square me-2"></i>Edit
                                            </a>
                                          </div>
                                          <div>
                                            <a href="javascript:void(0);" @click="handleDelete(secondLevel.id)"
                                              class="badge bg-danger text-white text-decoration-none mb-1"><i
                                                class="fas fa-trash-alt me-2"></i>Hapus</a>
                                          </div>
                                    </td>
                                </tr>
                            </template>
                            <template v-if="satkerLevel == 0 && topLevel.detail.length > 0">
                                <!-- Level 3 -->
                                <template v-for="(thirdLevel, index3) in topLevel.detail">
                                    <tr class="bg-soft-gray">
                                        <td>{ index+1 }.{ index3+1 }</td>
                                        <td colspan="8"><v-section-header :satker='thirdLevel.satker.nama_satker' :jumlah="thirdLevel.data.length" /></td>
                                        <td></td>
                                    </tr>
                                    <!-- Level 4 -->
                                    <template v-for="(fourthLevel, index) in thirdLevel.data">
                                        <tr>
                                            <td></td>
                                            <td></td>
                                            <td>
                                                { fourthLevel.tanggal_awal } s/d { fourthLevel.tanggal_akhir }
                                            </td>
                                            <td>
                                                <v-lokasi :provinsi="fourthLevel.nama_provinsi" :kabupaten="fourthLevel.nama_kabupaten" :kecamatan="fourthLevel.nama_kecamatan" :desa="fourthLevel.nama_desa"></v-lokasi>
                                            </td>
                                            <td>{ fourthLevel.deskripsi }</td>
                                            <td>{ fourthLevel.kendala }</td>
                                            <td>{ fourthLevel.kesimpulan }</td>
                                            <td>{ fourthLevel.tindak_lanjut }</td>
                                            <td>
                                                <div class="text-center">
                                                    <a :href="fourthLevel.dokumentasi" class="badge bg-primary text-white cursor-pointer" target="_blank">
                                                    <i class="fas fa-eye me-2"></i>
                                                    Lihat dokumentasi
                                                    </a>
                                                </div>
                                            </td>
                                            <!-- Action BTN -->
                                            <div class="list-button gx-3 text-uppercase">
                                                <div>
                                                  <a href="javascript:void(0);" class="badge bg-primary text-white text-decoration-none mb-1">
                                                    <i class="fa-regular fa-paper-plane me-2"></i>Kirim
                                                  </a>
                                                </div>
                                                <div>
                                                  <a href="javascript:void(0);" @click="handleEdit(fourthLevel.id)"
                                                    class="badge bg-success text-white text-decoration-none mb-1">
                                                    <i class="fas fa-pen-to-square me-2"></i>Edit
                                                  </a>
                                                </div>
                                                <div>
                                                  <a href="javascript:void(0);" @click="handleDelete(fourthLevel.id)"
                                                    class="badge bg-danger text-white text-decoration-none mb-1"><i
                                                      class="fas fa-trash-alt me-2"></i>Hapus</a>
                                                </div>
                                              </div>
                                        </tr>
                                    </template>
                                </template>
                                
                            </template>
                        </template>
                    </tbody>
                </table>

            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block js_tambahan %}
<script type="text/javascript" src="https://oss.sheetjs.com/sheetjs/xlsx.full.min.js"></script>

<script>
    const Lokasi = {
        name: 'Lokasi',
        props: ['provinsi', 'kabupaten', 'kecamatan', 'desa'],
        delimiters: ['{', '}'],
        template: `
            <ul class="location__list">
                <li><span class="location__label">Provinsi</span>:<span class="location__value">{ provinsi }</span></li>
                <li><span class="location__label">Kabupaten/Kota</span>:<span class="location__value">{ kabupaten }</span></li>
                <li><span class="location__label">Kecamatan</span>:<span class="location__value">{ kecamatan }</span></li>
                <li><span class="location__label">Desa/Kelurahan</span>:<span class="location__value">{ desa }</span></li>
            </ul>
        `
    };
    
    const SectionHeader = {
        name: 'SectionHeader',
        props: ['satker', 'jumlah'],
        delimiters: ['{', '}'],
        template: `
            <span class="text-center"><span class="fw-bold me-2">{ satker }</span> ({ jumlah } kegiatan)</span>
        `
    };

    const {
        createApp,
        reactive,
        ref,
        onMounted,
        computed,
    } = Vue;

    const app = createApp({
        delimiters: ['{', '}'],
        components: {
            'v-section-header': SectionHeader,
            'v-lokasi': Lokasi,
        },
        setup() {
            const store = reactive({
                count: 0,
                increment() {
                  this.count++
                }
            });

            const title = ref('Pemetaan Potensi');

            const satkerLevel = ref(parseInt('{{ user.profile.satker.level }}'));

            let statusPengirimanSemua = ref('{{ satker_status_pengiriman_semua_kegiatan }}' == 'True' ? true : false);

            const setStatusPengirimanSemua = (value) => statusPengirimanSemua.value = value;

            const tableData = ref(null);

            const searchQuery = ref('');

            const loadData = async () => {
                const apiURL = satkerLevel.value == 0 ? '/kegiatan/api/v1/dayatif/pemetaan_potensi/list/?format=datatables' : '/kegiatan/api/v1/dayatif/pemetaan_potensi/list/get_data_bnnk/?format=datatables';

                const response = await axios.get(apiURL);
                const data = response.data.data;

                data.forEach(item => {
                    if (satkerLevel.value == 0) {
                        if (item.detail.length == 0) {
                            item.has_child = false;
                        } else {
                            item.has_child = true;
                        }
                    }
                })
                tableData.value = data;

                console.log('Initial Data:', tableData.value);
            };

            const performSearch = () => {
                if (!tableData.value) return [];

                return tableData.value.filter(item => {
                    return item.satker?.nama_satker?.toLowerCase().includes(searchQuery.value.toLowerCase());
                });
            };

            const filteredTableData = computed(() => {
                return performSearch();
            });

            const post = ref({
                provinsi: '',
                kabupaten: '',
                kecamatan: '',
                desa: ''
            });

            const onPostFileChange = (event) => {
                post.value.dokumen = event.target.files[0];
            };

            const handlePost = async () => {
                console.log('Post Data:', post.value);
                showSwalLoading();

                const modal = $('#createModal');
                const form = $('#createForm');

                const satker = form.find('#create__satker').val();
                const tanggal_awal = form.find('#create__tanggal_awal').val();
                const tanggal_akhir = form.find('#create__tanggal_akhir').val();

                const provinsi = form.find('#create__provinsi').val();
                const kabupaten = form.find('#create__kabupaten').val();
                const kecamatan = form.find('#create__kecamatan').val();
                const desa = form.find('#create__desa').val();

                const nama_provinsi = form.find('#create__provinsi option:selected').text();
                const nama_kabupaten = form.find('#create__kabupaten option:selected').text();
                const nama_kecamatan = form.find('#create__kecamatan option:selected').text();
                const nama_desa = form.find('#create__desa option:selected').text();

                const deskripsi = form.find('#create__deskripsi').val();
                const kendala = form.find('#create__kendala').val();
                const kesimpulan = form.find('#create__kesimpulan').val();
                const tindak_lanjut = form.find('#create__tindak_lanjut').val();
                const dokumentasi = form.find('#create__dokumentasi')[0].files[0];

                const payload = {
                    satker,
                    tanggal_awal,
                    tanggal_akhir,
                    provinsi,
                    nama_provinsi,
                    kabupaten,
                    nama_kabupaten,
                    kecamatan,
                    nama_kecamatan,
                    desa,
                    nama_desa,
                    deskripsi,
                    kendala,
                    kesimpulan,
                    tindak_lanjut,
                    dokumentasi
                };

                const formData = new FormData();

                formData.append('satker', parseInt(satker));
                formData.append('tanggal_awal', tanggal_awal);
                formData.append('tanggal_akhir', tanggal_akhir);
                formData.append('provinsi', provinsi);
                formData.append('nama_provinsi', nama_provinsi);
                formData.append('kabupaten', kabupaten);
                formData.append('nama_kabupaten', nama_kabupaten);
                formData.append('kecamatan', kecamatan);
                formData.append('nama_kecamatan', nama_kecamatan);
                formData.append('desa', desa);
                formData.append('nama_desa', nama_desa);
                formData.append('deskripsi', deskripsi);
                formData.append('kendala', kendala);
                formData.append('kesimpulan', kesimpulan);
                formData.append('tindak_lanjut', tindak_lanjut);
                formData.append('dokumentasi', dokumentasi);

                console.log('Payload :', payload);

                try {
                    const response = await axios.post(`/kegiatan/api/v1/dayatif/pemetaan_potensi/`,
                        formData, {
                            headers: {
                                'Content-Type': 'multipart/form-data',
                            },
                        }
                    );

                    modal.modal('hide');
                    showSwalSuccess('Berhasil!', `Data kegiatan telah <b>berhasil</b> ditambahkan!`);
                } catch (error) {
                    showSwalGenericError();
                    console.error('Terjadi kesalahan :', error);
                } finally {
                    await loadData();
                }
            }

            const edit = ref({
                provinsi: '',
                kabupaten: '',
                kecamatan: '',
                desa: ''
            });

            const handleEdit = async (id) => {
                console.log('Edit ID:', id);
            }

            const inputTargets = [
                { type: 'create', name: 'provinsi', subName: 'nama_provinsi', element: '#create__provinsi' },
                { type: 'create', name: 'kabupaten', subName: 'nama_kabupaten', element: '#create__kabupaten' },
                { type: 'create', name: 'kecamatan', subName: 'nama_kecamatan', element: '#create__kecamatan' },
                { type: 'create', name: 'desa', subName: 'nama_desa', element: '#create__desa' },
                { type: 'edit', name: 'provinsi', subName: 'nama_provinsi', element: '#edit__provinsi' },
                { type: 'edit', name: 'kabupaten', subName: 'nama_kabupaten', element: '#edit__kabupaten' },
                { type: 'edit', name: 'kecamatan', subName: 'nama_kecamatan', element: '#edit__kecamatan' },
                { type: 'edit', name: 'desa', subName: 'nama_desa', element: '#edit__desa' }
            ];

            onMounted(async () => {
                await loadData();

                console.log('Status pengiriman semua :', statusPengirimanSemua.value);
                console.log('Satker level :', satkerLevel.value);

                inputTargets.forEach(item => {
                    $(item.element).on('change', (event) => {
                        const selectedText = $(item.element).find(':selected').text();
                        const valueToSet = event.target.value;

                        if (item.type === 'create') {
                            post.value[item.name] = valueToSet;
                            post.value[item.subName] = selectedText;

                            console.log(`${item.name} :`, post.value[item.name])
                            console.log(`${item.subName} :`, post.value[item.subName])
                        } else {
                            edit.value[item.name] = valueToSet;
                            edit.value[item.subName] = selectedText;
                        }
                    });
                });
            });

            return {
                store,
                tableData: filteredTableData,
                title,
                loadData,
                post,
                onPostFileChange,
                handlePost,
                edit,
                handleEdit,

                satkerLevel,
                statusPengirimanSemua,
                setStatusPengirimanSemua,
                searchQuery,
                performSearch,
            }
        },
    }).mount('#app')
</script>

<script>
    const API_LOKASI_URL = 'http://103.210.54.17:8003';
    let listProvinces = null;

    async function fetchDropdownData(url, id, dropdown, type, resetFunction) {
        if (!id) return;

        resetFunction();

        try {
            const response = await axios.get(url);

            response.data.forEach(value => {
                dropdown.append($('<option>', {
                    value: value.id,
                    text: value[`nama_${type}`]
                }));
            });

            dropdown.removeAttr('disabled');
        } catch (error) {
            console.error('Error:', error);
        }
    }

    const API_URLS = {
        regencies: API_LOKASI_URL + '/dashboard/masters/api/v1/list_regencies/?provinsi=',
        districts: API_LOKASI_URL + '/dashboard/masters/api/v1/list_districts/?kabupaten=',
        villages: API_LOKASI_URL + '/dashboard/masters/api/v1/list_villages/?kecamatan=',
        provinces: API_LOKASI_URL + '/dashboard/masters/api/v1/provinces/',
    };

    const dropdownOptions = {
        kabupaten: { resetFunction: resetKabupaten, url: API_URLS.regencies },
        kecamatan: { resetFunction: resetKecamatan, url: API_URLS.districts },
        desa: { resetFunction: resetDesa, url: API_URLS.villages }
    };

    async function loadDropdownData(type, id, dropdown) {
        const { resetFunction, url } = dropdownOptions[type];
        await fetchDropdownData(`${url}${id}`, id, dropdown, type, resetFunction);
    }

    async function fetchProvinsi() {
        try {
            const response = await axios.get(API_URLS.provinces);
            listProvinces = response.data.results;
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function assignProvinsi(type) {
        const provinsiDropdown = $(`#${type}__provinsi`);

        listProvinces.forEach(value => {
            provinsiDropdown.append($('<option>', {
                value: value.id,
                text: value.nama_provinsi
            }));
        });

        provinsiDropdown.removeAttr('disabled');
    }

    const semua_option = `<option value="">Semua</option>`;

    function resetKabupaten(type) {
        $(`#${type}__kabupaten`).empty();
        $(`#${type}__kabupaten`).append($(`<option>`, {
            value: '',
            text: '--Pilih kabupaten/kota--',
            disabled: true,
        }));
        $(`#${type}__kabupaten`).prop(`disabled`, true);
        $(`#${type}__kecamatan`).prop(`disabled`, true);

        $(`#${type}__kabupaten`).append(semua_option);
    }

    function resetKecamatan(type) {
        $(`#${type}__kecamatan`).empty();
        $(`#${type}__kecamatan`).append($('<option>', {
            value: '',
            text: '--Pilih kecamatan--',
            disabled: true
        }));
        $(`#${type}__kecamatan`).prop('disabled', true);
        $(`#${type}__kecamatan`).append(semua_option);
    }

    function resetDesa(type) {
        $(`#${type}__desa`).empty();
        $(`#${type}__desa`).append($('<option>', {
            value: '',
            text: '--Pilih desa/kelurahan--',
            disabled: true
        }));
        $(`#${type}__desa`).prop('disabled', true);
        $(`#${type}__desa`).append(semua_option);
    }

    $(function () {
        (async () => {
            try {
                await fetchProvinsi();
                await assignProvinsi('create');
                await assignProvinsi('edit');

                $('#create__provinsi, #edit__provinsi').on('change', async function () {
                    const value = $(this).val();
                    const type = $(this).attr('id').split('__')[0];

                    if (value && value !== '') {
                        await loadDropdownData('kabupaten', value, $(`#${type}__kabupaten`));
                    } else {
                        resetKabupaten(type);
                        resetKecamatan(type);
                        resetDesa(type);
                    }
                });

                $('#create__kabupaten, #edit__kabupaten').on('change', async function () {
                    const value = $(this).val();
                    const type = $(this).attr('id').split('__')[0];

                    if (value && value !== '') {
                        await loadDropdownData('kecamatan', value, $(`#${type}__kecamatan`));
                    } else {
                        resetKecamatan(type);
                        resetDesa(type);
                    }
                });

                $('#create__kecamatan, #edit__kecamatan').on('change', async function () {
                    const value = $(this).val();
                    const type = $(this).attr('id').split('__')[0];

                    if (value && value !== '') {
                        await loadDropdownData('desa', value, $(`#${type}__desa`));
                    } else {
                        resetDesa(type);
                    }
                });

            } catch (error) {
                console.error('Terjadi kesalahan saat memuat data statistik :', error);
            }
        })();

    
        $('#filter__date').daterangepicker({
            ranges: {
               'Today': [moment(), moment()],
               'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
               'Last 7 Days': [moment().subtract(6, 'days'), moment()],
               'Last 30 Days': [moment().subtract(29, 'days'), moment()],
               'This Month': [moment().startOf('month'), moment().endOf('month')],
               'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
            }
        });
    });

    
</script>

{% endblock %}
{% block modal_tambahan %}
{% include 'dayatif/pemetaan_potensi/modals/create_modal.html'%}
{% include 'dayatif/pemetaan_potensi/modals/edit_modal.html' %}
{% endblock %}

{% block css_tambahan %}

<style>
	#detail__lokasi {
		width: 250px
	}
	
	#detail__lokasi .detail__value {
		padding-left: 10px;
	}

	#edit__selected_lokasi li span {
		padding-left: 10px;
	}

	#edit__selected_lokasi .edit__selected_lokasi_label {
		width: 150px;
        display: inline-block;
	}

    ul.location__list {
        text-align: left;
    }
    
    ul.location__list .location__label {
        width: 150px;
        display: inline-block;
        font-weight: bold;
    }
    
    ul.location__list .location__value {
        display: inline-block;
    }
</style>

{% endblock css_tambahan %}